{% extends 'base.html' %}

{% block title %}Team Rankings - {{ category.name }} - PopQuiz{% endblock %}

{% block content %}
<div class="mb-6">
    <a href="{% url 'category_detail' category.slug %}" class="text-indigo-600 hover:underline">&larr; Back to {{ category.name }}</a>
</div>

{% include 'catalog/_category_switcher.html' %}

<div class="bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-500 rounded-2xl shadow-xl p-8 mb-8 text-white">
    <h1 class="text-3xl font-bold mb-2">Team Rankings: {{ category.name }}</h1>
    <p class="text-white/80">{{ category.item_label|capfirst }}s ranked by team preference ({{ team_count }} team members)</p>
</div>

{% if ranked_movies %}
<div class="space-y-4">
    {% for item_data in ranked_movies %}
    <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition duration-200">
        <div class="flex items-center p-4">
            <!-- Rank Badge -->
            <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg mr-4
                {% if item_data.score is not None %}
                    {% if forloop.counter == 1 %}bg-yellow-400 text-yellow-900
                    {% elif forloop.counter == 2 %}bg-gray-300 text-gray-700
                    {% elif forloop.counter == 3 %}bg-amber-600 text-white
                    {% else %}bg-gray-100 text-gray-600{% endif %}
                {% else %}bg-gray-50 text-gray-400{% endif %}">
                #{{ forloop.counter }}
            </div>

            <!-- Poster -->
            <div class="flex-shrink-0 w-16 h-24 mr-4">
                {% if item_data.item.poster_url %}
                <img src="{{ item_data.item.poster_url }}" alt="{{ item_data.item.title }}"
                     class="w-full h-full object-cover rounded-lg"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="w-full h-full bg-gray-200 rounded-lg items-center justify-center" style="display: none;">
                    <svg class="w-6 h-6" fill="#9ca3af" viewBox="0 0 24 24">
                        <path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/>
                    </svg>
                </div>
                {% else %}
                <div class="w-full h-full bg-gray-200 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6" fill="#9ca3af" viewBox="0 0 24 24">
                        <path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/>
                    </svg>
                </div>
                {% endif %}
            </div>

            <!-- Title and Year -->
            <div class="flex-grow min-w-0 mr-4">
                <a href="{% url 'item_detail' category.slug item_data.item.id %}" class="hover:text-indigo-600 transition">
                    <h3 class="font-bold text-gray-800 truncate hover:text-indigo-600">{{ item_data.item.title }}</h3>
                </a>
                {% if item_data.item.year %}
                <p class="text-gray-500 text-sm">{{ item_data.item.year }}</p>
                {% endif %}
            </div>

            {% if item_data.score is not None %}
            <!-- Score -->
            <div class="flex-shrink-0 text-center mr-6">
                <div class="text-2xl font-bold {% if item_data.score > 0 %}text-green-600{% elif item_data.score < 0 %}text-red-600{% else %}text-gray-500{% endif %}">
                    {% if item_data.score > 0 %}+{% endif %}{{ item_data.score }}
                </div>
                <div class="text-xs text-gray-500">score</div>
            </div>

            <!-- Rating Breakdown -->
            <div class="flex-shrink-0 flex items-center space-x-2">
                <div class="text-center">
                    <div class="flex items-center justify-center w-9 h-9 bg-red-100 rounded-full">
                        <span class="text-red-700 font-semibold text-sm">{{ item_data.hated_count }}</span>
                    </div>
                    <div class="text-lg text-gray-500 mt-1">ğŸ˜¡</div>
                </div>
                <div class="text-center">
                    <div class="flex items-center justify-center w-9 h-9 bg-orange-100 rounded-full">
                        <span class="text-orange-700 font-semibold text-sm">{{ item_data.disliked_count }}</span>
                    </div>
                    <div class="text-lg text-gray-500 mt-1">ğŸ˜•</div>
                </div>
                <div class="text-center">
                    <div class="flex items-center justify-center w-9 h-9 bg-yellow-100 rounded-full">
                        <span class="text-yellow-700 font-semibold text-sm">{{ item_data.okay_count }}</span>
                    </div>
                    <div class="text-lg text-gray-500 mt-1">ğŸ˜</div>
                </div>
                <div class="text-center">
                    <div class="flex items-center justify-center w-9 h-9 bg-green-100 rounded-full">
                        <span class="text-green-700 font-semibold text-sm">{{ item_data.liked_count }}</span>
                    </div>
                    <div class="text-lg text-gray-500 mt-1">ğŸ™‚</div>
                </div>
                <div class="text-center">
                    <div class="flex items-center justify-center w-9 h-9 bg-purple-100 rounded-full">
                        <span class="text-purple-700 font-semibold text-sm">{{ item_data.loved_count }}</span>
                    </div>
                    <div class="text-lg text-gray-500 mt-1">ğŸ¤©</div>
                </div>
            </div>
            {% else %}
            <!-- No ratings yet -->
            <div class="flex-shrink-0 text-gray-400 italic">
                No ratings yet
            </div>
            {% endif %}
        </div>

        {% if item_data.total_ratings > 0 %}
        <!-- Progress Bar -->
        <div class="h-2 flex">
            {% if item_data.hated_percent > 0 %}
            <div class="bg-red-500" style="width: {{ item_data.hated_percent }}%"></div>
            {% endif %}
            {% if item_data.disliked_percent > 0 %}
            <div class="bg-orange-500" style="width: {{ item_data.disliked_percent }}%"></div>
            {% endif %}
            {% if item_data.okay_percent > 0 %}
            <div class="bg-yellow-400" style="width: {{ item_data.okay_percent }}%"></div>
            {% endif %}
            {% if item_data.liked_percent > 0 %}
            <div class="bg-green-500" style="width: {{ item_data.liked_percent }}%"></div>
            {% endif %}
            {% if item_data.loved_percent > 0 %}
            <div class="bg-purple-500" style="width: {{ item_data.loved_percent }}%"></div>
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% else %}
<div class="bg-white rounded-2xl shadow-xl p-12 text-center">
    <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
        <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
        </svg>
    </div>
    <h2 class="text-2xl font-bold text-gray-800 mb-2">No {{ category.item_label|capfirst }}s Yet</h2>
    <p class="text-gray-600">Add some {{ category.item_label }}s to see team rankings!</p>
</div>
{% endif %}

<!-- Legend -->
<div class="bg-white rounded-xl shadow-md p-6 mt-8">
    <h3 class="font-semibold text-gray-700 mb-3">How Scores Work</h3>
    <p class="text-gray-600 text-sm">
        {{ category.item_label|capfirst }}s are ranked using Bayesian averaging. Each rating has a numeric value:
        <span class="inline-flex items-center mx-1 px-2 py-0.5 bg-red-100 text-red-700 rounded"><span class="text-lg leading-none">ğŸ˜¡</span> Hated = -2</span>
        <span class="inline-flex items-center mx-1 px-2 py-0.5 bg-orange-100 text-orange-700 rounded"><span class="text-lg leading-none">ğŸ˜•</span> Disliked = -1</span>
        <span class="inline-flex items-center mx-1 px-2 py-0.5 bg-yellow-100 text-yellow-700 rounded"><span class="text-lg leading-none">ğŸ˜</span> Okay = 0</span>
        <span class="inline-flex items-center mx-1 px-2 py-0.5 bg-green-100 text-green-700 rounded"><span class="text-lg leading-none">ğŸ™‚</span> Liked = +1</span>
        <span class="inline-flex items-center mx-1 px-2 py-0.5 bg-purple-100 text-purple-700 rounded"><span class="text-lg leading-none">ğŸ¤©</span> Loved = +2</span>
    </p>
    <p class="text-gray-500 text-sm mt-2">
        Scores use Bayesian averaging to balance ratings with overall team averages. Items with fewer votes are pulled toward the mean, preventing single ratings from dominating the rankings. "Haven't Seen" ratings are not counted.
    </p>
</div>
{% endblock %}
